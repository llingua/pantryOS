<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Open Facts API v3</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; width: 200px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Test Open Facts API v3</h1>

        <div class="test-section">
            <h3>ğŸ” Test Ricerca Prodotto</h3>
            <input type="text" id="barcode-input" placeholder="Inserisci barcode (es. 3017620422003)" value="3017620422003">
            <button onclick="testProductSearch()">Cerca Prodotto</button>
            <button onclick="testMultipleBarcodes()">Test Multipli Barcode</button>
            <div id="search-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸŒ Test Lingue e Paesi</h3>
            <div style="margin: 10px 0;">
                <label for="language-select" style="margin-right: 10px;"><strong>Lingua:</strong></label>
                <select id="language-select" onchange="changeLanguage()">
                    <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                    <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                    <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                    <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                    <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                </select>
                <span id="current-language"></span>
            </div>
            <div style="margin: 10px 0;">
                <label for="country-select" style="margin-right: 10px;"><strong>Paese:</strong></label>
                <select id="country-select" onchange="changeCountry()">
                    <option value="it">ğŸ‡®ğŸ‡¹ Italia</option>
                    <option value="us">ğŸ‡ºğŸ‡¸ USA</option>
                    <option value="gb">ğŸ‡¬ğŸ‡§ Regno Unito</option>
                    <option value="fr">ğŸ‡«ğŸ‡· Francia</option>
                    <option value="de">ğŸ‡©ğŸ‡ª Germania</option>
                    <option value="es">ğŸ‡ªğŸ‡¸ Spagna</option>
                </select>
                <span id="current-country"></span>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š Informazioni Cache</h3>
            <button onclick="showCacheInfo()">Mostra Cache</button>
            <button onclick="clearCache()">Pulisci Cache</button>
            <div id="cache-info" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ Test Configurazione</h3>
            <button onclick="testConfig()">Test Config App</button>
            <div id="config-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script src="./pantryos/pantryos-addon/app/public/utils/open-facts-api.js"></script>
    <script>
        // Barcode di test comuni
        const testBarcodes = [
            { code: '3017620422003', name: 'Nutella' },
            { code: '8076809510001', name: 'Coca Cola' },
            { code: '8000500310427', name: 'Barilla Pasta' },
            { code: '8001090300000', name: 'Parmigiano Reggiano' },
            { code: '8001090300000', name: 'Parmigiano Reggiano' }
        ];

        async function testProductSearch() {
            const barcode = document.getElementById('barcode-input').value.trim();
            if (!barcode) {
                showResult('search-result', 'error', 'âŒ Inserisci un barcode');
                return;
            }

            showResult('search-result', 'info', 'ğŸ” Ricerca in corso...');

            try {
                console.log('ğŸ” Test ricerca prodotto:', barcode);
                const result = await OpenFactsAPI.searchProductByBarcode(barcode);

                if (result && !result.error) {
                    showResult('search-result', 'success',
                        `âœ… Prodotto trovato!\n\n` +
                        `ğŸ“¦ Nome: ${result.name}\n` +
                        `ğŸ·ï¸ Marca: ${result.brand || 'N/A'}\n` +
                        `ğŸ“ Descrizione: ${result.description || 'N/A'}\n` +
                        `ğŸŒ Lingua: ${result.languageName} (${result.language})\n` +
                        `ğŸ”— Fonte: ${result.source}\n` +
                        `ğŸ–¼ï¸ Immagine: ${result.imageUrl ? 'âœ…' : 'âŒ'}\n` +
                        `ğŸ“Š Dati completi: ${JSON.stringify(result, null, 2)}`
                    );
                } else {
                    showResult('search-result', 'error',
                        `âŒ Prodotto non trovato: ${result?.error || 'Errore sconosciuto'}`
                    );
                }
            } catch (error) {
                showResult('search-result', 'error', `âŒ Errore: ${error.message}`);
            }
        }

        async function testMultipleBarcodes() {
            showResult('search-result', 'info', 'ğŸ” Test multipli barcode...');

            for (const test of testBarcodes) {
                try {
                    console.log(`ğŸ” Test: ${test.name} (${test.code})`);
                    const result = await OpenFactsAPI.searchProductByBarcode(test.code);

                    if (result && !result.error) {
                        console.log(`âœ… ${test.name}: ${result.name}`);
                    } else {
                        console.log(`âŒ ${test.name}: Non trovato`);
                    }
                } catch (error) {
                    console.log(`âŒ ${test.name}: Errore - ${error.message}`);
                }

                // Pausa tra le richieste per non sovraccaricare l'API
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            showResult('search-result', 'success', 'âœ… Test multipli completati! Controlla la console per i dettagli.');
        }

        async function changeLanguage() {
            const langSelect = document.getElementById('language-select');
            const selectedLang = langSelect.value;

            if (OpenFactsAPI.setLanguage(selectedLang)) {
                await updateLanguageDisplay();
                showResult('search-result', 'info', `ğŸŒ Lingua cambiata a: ${OpenFactsAPI.getSupportedLanguages()[selectedLang]}`);
            } else {
                showResult('search-result', 'error', `âŒ Lingua non supportata: ${selectedLang}`);
            }
        }

        async function changeCountry() {
            const countrySelect = document.getElementById('country-select');
            const selectedCountry = countrySelect.value;

            if (OpenFactsAPI.setCountry(selectedCountry)) {
                await updateCountryDisplay();
                showResult('search-result', 'info', `ğŸ³ï¸ Paese cambiato a: ${selectedCountry}`);
            } else {
                showResult('search-result', 'error', `âŒ Paese non supportato: ${selectedCountry}`);
            }
        }

        async function updateLanguageDisplay() {
            const currentLang = OpenFactsAPI.getLanguage();
            const langSelect = document.getElementById('language-select');
            const currentLangSpan = document.getElementById('current-language');

            langSelect.value = currentLang;
            const supportedLangs = OpenFactsAPI.getSupportedLanguages();
            currentLangSpan.textContent = `(Attuale: ${supportedLangs[currentLang] || currentLang})`;
        }

        async function updateCountryDisplay() {
            const currentCountry = OpenFactsAPI.getCountry();
            const countrySelect = document.getElementById('country-select');
            const currentCountrySpan = document.getElementById('current-country');

            countrySelect.value = currentCountry;
            currentCountrySpan.textContent = `(Attuale: ${currentCountry})`;
        }

        async function testConfig() {
            showResult('config-result', 'info', 'ğŸ”§ Test configurazione...');

            try {
                await OpenFactsAPI.reloadConfig();
                const currentLang = OpenFactsAPI.getLanguage();
                const currentCountry = OpenFactsAPI.getCountry();
                const supportedLangs = OpenFactsAPI.getSupportedLanguages();

                showResult('config-result', 'success',
                    `âœ… Configurazione caricata!\n\n` +
                    `ğŸŒ Lingua corrente: ${supportedLangs[currentLang]} (${currentLang})\n` +
                    `ğŸ³ï¸ Paese corrente: ${currentCountry}\n` +
                    `ğŸ”§ Configurazione ricaricata con successo`
                );
            } catch (error) {
                showResult('config-result', 'error', `âŒ Errore configurazione: ${error.message}`);
            }
        }

        function showCacheInfo() {
            const cache = OpenFactsAPI.getCacheInfo();
            showResult('cache-info', 'info',
                `ğŸ“Š Informazioni Cache:\n\n` +
                `ğŸ“¦ Elementi in cache: ${cache.size}\n` +
                `â° Durata cache: 24 ore\n` +
                `ğŸŒ Lingua: ${cache.currentLanguage}\n` +
                `ğŸ³ï¸ Paese: ${cache.currentCountry}\n` +
                `ğŸ” Chiavi: ${Array.from(cache.keys()).join(', ') || 'Nessuna'}`
            );
        }

        function clearCache() {
            OpenFactsAPI.clearCache();
            showResult('cache-info', 'success', 'âœ… Cache pulita!');
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.style.display = 'block';
            element.innerHTML = `<pre>${message}</pre>`;
        }

        // Inizializzazione
        window.addEventListener('load', async () => {
            await updateLanguageDisplay();
            await updateCountryDisplay();
            showCacheInfo();
        });
    </script>
</body>
</html>
